<script>
    let allContacts = [];
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSZEVFw70pjDNKkIa4JxtpuTu_pizLLb-YTPtyk5WTNRC2hz5PvUqiDXh4OyonQjsDEmqT4cGjhzG1r/pub?gid=1397364136&single=true&output=csv&t=' + new Date().getTime();

    function loadData() {
        fetch(csvUrl)
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allContacts = results.data.map(row => ({
                            firstName: row['firstName'] || '',
                            lastName: row['lastName'] || '',
                            pluga: row['pluga'] || '',
                            framework: row['framework'] || '',
                            role: row['role'] || '',
                            mobile: row['mobile'] || '',
                            mobileWA: row['mobileWA'] || ''
                        })).filter(c => c.firstName !== '');

                        updatePlugaDropdown();
                        updateFrameworkDropdown();
                        renderContacts(allContacts);
                    }
                });
            });
    }

    // ×¢×“×›×•×Ÿ ×“×¨×•×¤×“××•×Ÿ ×¤×œ×•×’×•×ª (×§×•×¨×” ×¤×¢× ××—×ª ×‘×˜×¢×™× ×”)
    function updatePlugaDropdown() {
        const pSelect = document.getElementById('companyFilter');
        const plugot = [...new Set(allContacts.map(c => c.pluga))].filter(Boolean).sort();
        pSelect.innerHTML = '<option value="">×›×œ ×”×¤×œ×•×’×•×ª</option>';
        plugot.forEach(p => pSelect.innerHTML += `<option value="${p}">${p}</option>`);
    }

    // ×¢×“×›×•×Ÿ ×“×¨×•×¤×“××•×Ÿ ××¡×’×¨×•×ª (××©×ª× ×” ×œ×¤×™ ×”×¤×œ×•×’×” ×©× ×‘×—×¨×”)
    function updateFrameworkDropdown() {
        const selectedPluga = document.getElementById('companyFilter').value;
        const fSelect = document.getElementById('unitFilter');
        
        // ×¡×™× ×•×Ÿ ×”××¡×’×¨×•×ª ×”×¨×œ×•×•× ×˜×™×•×ª
        const relevantContacts = selectedPluga 
            ? allContacts.filter(c => c.pluga === selectedPluga)
            : allContacts;
            
        const frameworks = [...new Set(relevantContacts.map(c => c.framework))].filter(Boolean).sort();
        
        fSelect.innerHTML = '<option value="">×›×œ ×”××¡×’×¨×•×ª</option>';
        frameworks.forEach(f => fSelect.innerHTML += `<option value="${f}">${f}</option>`);
    }

    function renderContacts(contacts) {
        const grid = document.getElementById('contactsGrid');
        grid.innerHTML = contacts.length ? '' : '<div class="text-center mt-5">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';
        contacts.forEach(c => {
            grid.innerHTML += `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="contact-card text-center shadow-sm">
                        <div class="name-header">${c.firstName} ${c.lastName}</div>
                        <div class="info-sub">${c.pluga} â€¢ ${c.framework}<br><strong>${c.role}</strong></div>
                        <div class="btn-group-custom">
                            <a href="tel:${c.mobile}" class="btn-custom tel-btn">ğŸ“ ×—×™×•×’</a>
                            <a href="https://wa.me/${c.mobileWA}" target="_blank" class="btn-custom wa-btn">ğŸ’¬ WhatsApp</a>
                            <button onclick="downloadVCard('${c.firstName}','${c.lastName}','${c.mobile}','${c.pluga}','${c.role}')" class="btn-custom vcf-btn">ğŸ‘¤ ×©××™×¨×”</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    // ×¤×•× ×§×¦×™×™×ª ×”×¡×™× ×•×Ÿ ×”××¨×›×–×™×ª - ××•×¤×¢×œ×ª ×‘×›×œ ×©×™× ×•×™
    function filterContacts(isPlugaChange = false) {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const selectedPluga = document.getElementById('companyFilter').value;
        
        // ×× ×©×™× ×™× ×• ×¤×œ×•×’×”, ×× ×—× ×• ×¦×¨×™×›×™× ×œ×¢×“×›×Ÿ ××ª ×¨×©×™××ª ×”××¡×’×¨×•×ª
        if (isPlugaChange) {
            updateFrameworkDropdown();
        }
        
        const selectedFrame = document.getElementById('unitFilter').value;

        const filtered = allContacts.filter(c => {
            const
